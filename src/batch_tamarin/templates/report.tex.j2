\documentclass[11pt,a4paper]{article}
\usepackage[utf8]{inputenc}
\usepackage[T1]{fontenc}
\usepackage{geometry}
\usepackage{booktabs}
\usepackage{longtable}
\usepackage{array}
\usepackage{tabularx}
\usepackage{ltxtable}
\usepackage{ragged2e}
\usepackage{hyphenat}
\usepackage{xcolor}
\usepackage{url}
\usepackage{fancyhdr}
\usepackage{graphicx}
\usepackage{float}
\usepackage{listings}
\usepackage{datetime}
\usepackage{tikz}
\usepackage{pgfplots}
\usepackage{pgf-pie}
\usetikzlibrary{calc}
\pgfplotsset{compat=1.16}

\geometry{margin=1in}
\setlength{\headheight}{14pt}
\pagestyle{fancy}
\fancyhf{}
\fancyhead[L]{Batch Tamarin Execution Report}
\fancyhead[R]{\thepage}
\fancyfoot[C]{Generated on {{ report_data.generation_date.strftime('%Y-%m-%d at %H:%M:%S') }}}

\definecolor{successgreen}{RGB}{40, 167, 69}
\definecolor{failedred}{RGB}{220, 53, 69}
\definecolor{warningyellow}{RGB}{255, 193, 7}
\definecolor{infoblue}{RGB}{23, 162, 184}

\lstset{
    basicstyle=\ttfamily\footnotesize,
    breaklines=true,
    backgroundcolor=\color{gray!10},
    frame=single,
    framerule=0pt,
    rulecolor=\color{gray!30}
}

\title{Batch Tamarin Execution Report}
\author{Generated by Batch Tamarin}
\date{ {{ report_data.generation_date.strftime('%Y-%m-%d %H:%M:%S') }} }

\begin{document}

\maketitle

\section{Overview}

\textbf{Execution results from:} \texttt{ {{ report_data.results_directory|latex_escape }} }
\textbf{Executed:} {{ report_data.batch_execution_date.strftime('%Y-%m-%d %H:%M:%S') }}

\subsection{Configuration}

\subsubsection{Global Settings}

\begin{tabular}{ll}
\toprule
Setting & Value \\
\midrule
Max cores & {{ report_data.config.global_max_cores or 'Not specified' }} \\
Max memory & {{ report_data.config.global_max_memory or 'Not specified' }}GB \\
Default timeout & {{ report_data.config.default_timeout or 'Not specified' }}s \\
Output directory & \texttt{ {{ report_data.config.output_directory|latex_escape or 'Not specified' }} } \\
\bottomrule
\end{tabular}

\subsubsection{Tamarin Versions}

\begin{tabular}{lll}
\toprule
Alias & Path & Version \\
\midrule
{% for alias, info in report_data.config.tamarin_versions.items() %}
{{ alias|latex_escape }} & \texttt{ {{ info.path|latex_escape }} } & {{ info.version|latex_escape }} \\
{% endfor %}
\bottomrule
\end{tabular}

\subsection{Summary}

\subsubsection{Global Statistics}

\begin{tabular}{ll}
\toprule
Metric & Value \\
\midrule
Total tasks & {{ report_data.statistics.total_tasks }} \\
Extracted lemmas & {{ report_data.statistics.total_lemmas }} \\
Cached lemmas & {{ report_data.statistics.cache_hits }} \\
Successful tasks & \textcolor{successgreen}{ {{ report_data.statistics.successful_tasks }} ({{ "%.1f"|format(report_data.statistics.successful_tasks_percentage) }}\%) } \\
Failed tasks & \textcolor{failedred}{ {{ report_data.statistics.failed_tasks }} ({{ "%.1f"|format(report_data.statistics.failed_tasks_percentage) }}\%) } \\
Total runtime & {{ "%.2f"|format(report_data.statistics.total_runtime) }}s \\
Total memory usage (peak) & {{ "%.2f"|format(report_data.statistics.total_memory_usage) }}MB \\
\bottomrule
\end{tabular}

\subsubsection{Charts Overview}

\begin{figure}[h!]
    \centering
    \begin{minipage}{0.45\textwidth}
        \centering
        \begin{tikzpicture}
            \pie[text=legend, radius=2, sum=auto]{% raw %}{{% endraw %}
                {{ "%.1f"|format(report_data.statistics.successful_tasks_percentage) }}/Successful,
                {{ "%.1f"|format(report_data.statistics.failed_tasks_percentage) }}/Failed
            {% raw %}}{% endraw %}
        \end{tikzpicture}
        \caption{Success Rate Distribution}
    \end{minipage}
    \hfill
    \begin{minipage}{0.45\textwidth}
        \centering
        \begin{tikzpicture}
            \begin{axis}[
                ybar,
                width=6cm,
                height=4cm,
                ylabel={Tasks},
                symbolic x coords={Cached,Not Cached},
                xtick=data,
                nodes near coords,
                ymin=0,
            ]
            \addplot coordinates {% raw %}{{% endraw %}
                (Cached,{{ report_data.statistics.cache_hits }})
                (Not Cached,{{ report_data.statistics.total_tasks - report_data.statistics.cache_hits }})
            {% raw %}}{% endraw %};
            \end{axis}
        \end{tikzpicture}
        \caption{Cache Performance}
    \end{minipage}
\end{figure}

\subsubsection{Runtime per Task}
\begin{center}
\begin{tabular}{ll}
\toprule
Task & Average Runtime (seconds) \\
\midrule
{% for task in report_data.tasks %}
{{ task.name|latex_escape }} & {{ "%.2f"|format((task.results|sum(attribute='runtime')/task.results|length) if task.results else 0) }} \\
{% endfor %}
\bottomrule
\end{tabular}
\end{center}

\subsubsection{Memory Usage per Task}
\begin{center}
\begin{tabular}{ll}
\toprule
Task & Average Memory Usage (MB) \\
\midrule
{% for task in report_data.tasks %}
{{ task.name|latex_escape }} & {{ "%.2f"|format((task.results|sum(attribute='peak_memory')/task.results|length) if task.results else 0) }} \\
{% endfor %}
\bottomrule
\end{tabular}
\end{center}

\subsubsection{Execution Timeline}
\begin{center}
\begin{tabular}{lll}
\toprule
Task & Total Runtime (seconds) & Results Count \\
\midrule
{% for task in report_data.tasks %}
{{ task.name|latex_escape }} & {{ "%.2f"|format(task.results|sum(attribute='runtime') if task.results else 0) }} & {{ task.results|length }} \\
{% endfor %}
\bottomrule
\end{tabular}
\end{center}

\section{Task Details}

{% for task in report_data.tasks %}
\subsection{Task: {{ task.name|latex_escape }}}

\subsubsection{Execution Summary}

\begin{longtable}{>{\RaggedRight\arraybackslash\hspace{0pt}}p{1.6cm}>{\RaggedRight\arraybackslash\hspace{0pt}}p{1.6cm}>{\RaggedRight\arraybackslash\hspace{0pt}}p{0.9cm}>{\RaggedRight\arraybackslash\hspace{0pt}}p{0.9cm}>{\RaggedRight\arraybackslash\hspace{0pt}}p{0.9cm}>{\RaggedRight\arraybackslash\hspace{0pt}}p{1.3cm}>{\RaggedRight\arraybackslash\hspace{0pt}}p{1.1cm}>{\RaggedRight\arraybackslash\hspace{0pt}}p{1.1cm}>{\RaggedRight\arraybackslash\hspace{0pt}}p{1.1cm}>{\RaggedRight\arraybackslash\hspace{0pt}}p{0.9cm}}
\toprule
Lemma & Options & Cores & Memory & Timeout & Tamarin Version & Status & Memory Used & Runtime & Cache Hit \\
\midrule
\endfirsthead
\toprule
Lemma & Options & Cores & Memory & Timeout & Tamarin Version & Status & Memory Used & Runtime & Cache Hit \\
\midrule
\endhead
\bottomrule
\endfoot
{% for result in task.results %}
\texttt{ {{ result.lemma|latex_escape }} } & {{ result.tamarin_options|join(' ')|latex_escape if result.tamarin_options else 'None' }} & {{ result.max_cores or 'Default' }} & {{ result.max_memory or 'Default' }}GB & {{ result.timeout or 'Default' }}s & {{ result.tamarin_version|latex_escape }} & {% if result.status == "success" %}\textcolor{successgreen}{Success}{% else %}\textcolor{failedred}{Failed}{% endif %} & {{ "%.2f"|format(result.peak_memory) }}MB & {{ "%.2f"|format(result.runtime) }}s & {% if result.cache_hit %}\textcolor{successgreen}{Yes}{% else %}\textcolor{failedred}{No}{% endif %} \\
{% endfor %}
\end{longtable}

{% set task_traces = report_data.traces|selectattr('lemma', 'in', task.lemmas)|list %}
{% if task_traces %}
\subsubsection{Traces}

{% for trace in task_traces %}
\paragraph{ {{ trace.lemma|latex_escape }} ({{ trace.tamarin_version|latex_escape }}) }

\begin{itemize}
\item \textbf{JSON File:} \texttt{ {{ trace.json_file|latex_escape }} }
{% if trace.dot_file %}
\item \textbf{DOT File:} \texttt{ {{ trace.dot_file|latex_escape }} }
{% endif %}
\end{itemize}

{% if trace.dot_file %}
{% set png_file = trace.dot_file.replace('.dot', '.png') %}
\begin{figure}[H]
    \centering
    \IfFileExists{% raw %}{{% endraw %}{{ png_file|latex_escape }}{% raw %}}{% endraw %}{% raw %}{{% endraw %}%
        \includegraphics[width=0.6\textwidth,height=4cm,keepaspectratio]{% raw %}{{% endraw %}{{ png_file|latex_escape }}{% raw %}}{% endraw %}%
    {% raw %}}{% endraw %}{% raw %}{{% endraw %}%
        \textit{Trace visualization not available (DOT file: {{ trace.dot_file|latex_escape }})}%
    {% raw %}}{% endraw %}
    \caption{Trace visualization for {{ trace.lemma|latex_escape }}}
    \label{fig:trace_{{ loop.index }}}
\end{figure}
{% elif trace.svg_content %}
\begin{center}
\textit{Trace visualization available in other formats}
\end{center}
{% endif %}
{% endfor %}
{% endif %}

{% endfor %}

{% set failed_results = report_data.failed_results %}
{% if failed_results %}
\section{Errors}

\subsection{Error Summary}

\begin{longtable}{>{\RaggedRight\arraybackslash\hspace{0pt}}p{1.7cm}>{\RaggedRight\arraybackslash\hspace{0pt}}p{1.7cm}>{\RaggedRight\arraybackslash\hspace{0pt}}p{1.3cm}>{\RaggedRight\arraybackslash\hspace{0pt}}p{1.7cm}>{\RaggedRight\arraybackslash\hspace{0pt}}p{1.7cm}>{\RaggedRight\arraybackslash\hspace{0pt}}p{1.3cm}>{\RaggedRight\arraybackslash\hspace{0pt}}p{2.7cm}}
\toprule
Task & Lemma & Version & Options & Resources & Error Type & Description \\
\midrule
\endfirsthead
\toprule
Task & Lemma & Version & Options & Resources & Error Type & Description \\
\midrule
\endhead
\bottomrule
\endfoot
{% for error in report_data.error_details %}
\texttt{ {{ error.task|latex_escape }} } & \texttt{ {{ error.lemma|latex_escape }} } & {{ error.version|latex_escape }} & {{ error.options|latex_escape }} & {{ error.resources|latex_escape }} & {{ error.type|latex_escape }} & {{ error.message|latex_escape }} \\
{% endfor %}
\end{longtable}

\subsection{Detailed Error Information}

{% for result in failed_results %}
\subsubsection{ {{ result.task_name|latex_escape }}--{{ result.lemma|latex_escape }}--{{ result.tamarin_version|latex_escape }} }

{{ result.error_description|latex_escape }}

{% if result.stderr_lines %}
\begin{lstlisting}[language=bash]
{{ result.stderr_lines|join('\n')|latex_escape }}
\end{lstlisting}
{% endif %}
{% endfor %}
{% endif %}

\vfill

\begin{center}
\textit{Report generated by Batch Tamarin v{{ version or 'unknown' }} on {{ report_data.generation_date.strftime('%Y-%m-%d at %H:%M:%S') }}}
\end{center}

\end{document}
